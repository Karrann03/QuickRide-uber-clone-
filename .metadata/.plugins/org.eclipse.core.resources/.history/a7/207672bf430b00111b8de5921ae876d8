package com.kv.service;

import java.time.LocalDateTime;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.kv.RideStatus.RideStatus;
import com.kv.RideStatus.VehicleType;
import com.kv.dto.RideRequestDto;
import com.kv.dto.RideResponseDto;
import com.kv.entity.DriverEntity;
import com.kv.entity.RideEntity;
import com.kv.entity.UserEntity;
import com.kv.repository.DriverRepository;
import com.kv.repository.RideRepository;
import com.kv.repository.UserRepository;

@Service
public class RideServiceImpl implements IRideService {

	@Autowired
	private UserRepository userRepo;
	
	@Autowired
	private RideRepository rideRepo;
	
	private DriverRepository driverRepo;
	
	@Override
	public RideResponseDto requestRide(RideRequestDto request) {
		
		// Fetch User
		UserEntity user = userRepo.findById(request.getUserId()).orElseThrow(() -> new RuntimeException("User Not Found"));
		
		//Fetch All Available Drivers
		DriverEntity nearestDriver = findNearestDriver(request.getPickupLat(), request.getPickupLong(), request.getVehicleType());
		 
		if (nearestDriver == null) {
	            throw new RuntimeException("No available driver found");
	        }
		
		RideEntity ride = new RideEntity();
		ride.setUser(user);
		ride.setDriver(nearestDriver);
		ride.setPickupLat(request.getPickupLat());
	    ride.setPickupLong(request.getPickupLong());
	    ride.setDropLat(request.getDropLat());
	    ride.setDropLong(request.getDropLong());
	    ride.setStatus(RideStatus.REQUESTED.toString());
	    ride.setCreatedAt(LocalDateTime.now());
	    
	    // Calculate distance & fare
        double distanceKm = calculateDistance(request.getPickupLat(), request.getPickupLong(), request.getDropLat(), request.getDropLong());
        double fare = calculateFare(distanceKm, request.getVehicleType());

        rideRepo.save(ride);
        
        // Update driver availability
        nearestDriver.setAvailable(false);
        driverRepo.save(nearestDriver);
	    
		return null;
	}
	
	
	
	public DriverEntity findNearestDriver(double pickupLat, double pickupLong, VehicleType vehicleType) {
		List<DriverEntity> availableDrivers = driverRepo.findByAvailableTrueAndVehicleType(vehicleType);
		DriverEntity nearest = null;
		double minDistance = Double.MAX_VALUE;
		
		for (DriverEntity driver : availableDrivers) {
            double distance = Math.pow(driver.getLatitude() - pickupLat, 2) + Math.pow(driver.getLongitude() - pickupLong, 2);
            if (distance < minDistance) {
                minDistance = distance;
                nearest = driver;
            }
        }
        return nearest;
	}
	
	 // Simple distance calculation in km (Euclidean)
    private double calculateDistance(double lat1, double lon1, double lat2, double lon2) {
        double dx = lat2 - lat1;
        double dy = lon2 - lon1;
        return Math.sqrt(dx*dx + dy*dy) * 111; // rough km approximation
    }

    // Fare calculation based on distance & vehicle type
    private double calculateFare(double distanceKm, VehicleType vehicleType) {
        double baseFare = 50; // base fare
        double perKmRate = 10; // default

        switch (vehicleType) {
            case MINI_UV -> perKmRate = 10;
            case SEDAN -> perKmRate = 15;
            case SUV -> perKmRate = 20;
        }

        return baseFare + (perKmRate * distanceKm);
    }

}
